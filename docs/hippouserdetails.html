<!DOCTYPE html>
    <!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.2 at 27 June 2022 
 | Rendered using BloomReach Forge Maven Skin 3.1.1 based on Apache Maven Fluido Skin
-->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                  <meta name="Date-Revision-yyyymmdd" content="20220627" />
              <meta http-equiv="Content-Language" content="en" />
      <title>HST Spring Security Support Documentation &#x2013; Detail on HippoAuthenticationProvider component</title>
  <link rel="stylesheet" href="./css/forge-maven-skin-syntaxhighlighter-3.1.1.min.css"/>
  <link rel="stylesheet" href="./css/forge-maven-skin-3.1.1.min.css"/>
  <link rel="stylesheet" href="./css/site.css" />
  <link rel="stylesheet" href="./css/print.css" media="print" />
  <link rel="icon" type="image/png" href="./images/skin/logo_64.png" sizes="64x64">

  
  <script type="text/javascript" src="./js/forge-maven-skin-syntaxhighlighter-3.1.1.min.js"></script>
  <script type="text/javascript" src="./js/forge-maven-skin-3.1.1.min.js"></script>

    </head>
<body class="topBarDisabled">
                        <a href="https://github.com/bloomreach-forge/hst-spring-security">
    <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
         src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"
         alt="Fork me on GitHub">
  </a>
          <div class="container-fluid">
  <div id="banner">
    <div id="logo">
                        <a href="https://bloomreach-forge.github.io">
        <img src="./images/skin/logo.png" alt="BloomReach Forge Logo" />
      </a>
    </div>
    <div class="pull-left">              <div id="bannerLeft">    <h1>HST Spring Security Support</h1>
    </div>
              </div>
    <div class="pull-right"></div>
    <div class="clear"><hr/></div>
  </div>

  <div id="breadcrumbs">
                            <div class="links">
      <a href="https://documentation.bloomreach.com">documentation.bloomreach.com</a>
      <a href="https://developers.bloomreach.com">developers.bloomreach.com</a>
    </div>
    <ul class="breadcrumb">
    
  <li id="publishDate">published: 27 June 2022  
  </li>
  
        
            </ul>
    <div class="clear"><hr/></div>
  </div>
<div class="row-fluid">
  <div id="leftColumn" class="span2">
    <div class="well sidebar-nav">
    
    <ul class="nav nav-list">
            <li class="nav-header">Home</li>
              <li>  <a href="index.html" title="Home">  <span class="none"></span>  Home</a>  </li>
        <li>  <a href="release-notes.html" title="Release Notes">  <span class="none"></span>  Release Notes</a>  </li>
                  <li class="nav-header">Usage</li>
              <li>  <a href="install.html" title="Installation">  <span class="none"></span>  Installation</a>  </li>
        <li>  <a href="configuration.html" title="Configuration">  <span class="none"></span>  Configuration</a>  </li>
        <li class="active">  <a href="#"><span class="none"></span>Detail on HippoAuthenticationProvider</a>
  </li>
        <li>  <a href="runningdemo.html" title="Running Demo Application">  <span class="none"></span>  Running Demo Application</a>  </li>
        <li>  <a href="config-httpd.html" title="Configuring Apache HTTPd">  <span class="none"></span>  Configuring Apache HTTPd</a>  </li>
        <li>  <a href="build-from-source.html" title="Build from source">  <span class="none"></span>  Build from source</a>  </li>
                  <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                                        <li>  <a href="project-info.html" title="Project Information">  <span class="icon-chevron-right"></span>  Project Information</a>  </li>
        </ul>
    
          <hr />
      <div id="poweredBy">
                <div class="clear"></div>
                <div class="clear"></div>
                <div class="clear"></div>
                <div class="clear"></div>
              <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">  <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />  </a>
          </div>
    </div>
  </div>
  <div id="bodyColumn"  class="span10" >
    
  

    <section>
<h2><a name="Detail_on_HippoAuthenticationProvider_.28and_HippoUserDetailsService.29_component"></a>Detail on HippoAuthenticationProvider (and HippoUserDetailsService) component</h2>

      <section>
<h3><a name="Introduction"></a>Introduction</h3>
        
<p>
          This page will explain (a) how <code>HippoAuthenticationProvider</code> authenticates a user against Hippo Repository security data store,
          (b) how <code>HippoUserDetailsServiceImpl</code> assigns roles for the authenticated user.
        </p>
        
<p>
          Also see <a href="apidocs/index.html">API Javadoc</a> for details or customizations.
        </p>
      </section>

      <section>
<h3><a name="How_to_authenticate_a_user.3F"></a>How to authenticate a user?</h3>
        
<p>
          It is really simple!
          <code>HippoAuthenticationProvider</code> simply tries to invoke on <code>javax.jcr.Repository#login(Credentials)</code>
          by converting <code>username</code> and <code>UsernamePasswordAuthenticationToken</code> instance to <code>SimpleCredentials</code> instance.
        </p>
        
<p>
          If the login is sucessful, then the user should be authenticated. Otherwise, the authentication should fail.
        </p>
        
<p>
          See <a href="apidocs/org/onehippo/forge/security/support/springsecurity/authentication/HippoAuthenticationProvider.html">HippoAuthenticationProvider</a> for detail.
        </p>
      </section>

      <section>
<h3><a name="How_to_assign_roles_to_an_authenticated_user.3F"></a>How to assign roles to an authenticated user?</h3>
        
<p>
          It is a bit complex.
          <code>HippoUserDetailsServiceImpl</code> simply executes the following JCR query first to find all the assigned group names:
        </p>
        
<div class="brush: plain">
        
<div class="source"><pre>
//element(*, hipposys:group)[(@hipposys:members = '${username}' or @hipposys:members = '*')
and @hipposys:securityprovider = 'internal'];
        </pre></div>
        </div>
        
<p>
          <i><b>Note: </b></i> the ${username} is replaced by the real username at runtime.
        </p>

        
<p>
          Afterward, <code>HippoUserDetailsServiceImpl</code> executes a JCR query like the following example again
          to find all the <code>hipposys:authrole</code> nodes under <code>/hippo:configuration/hippo:domains</code>.
        </p>
        
<div class="brush: plain">
        
<div class="source"><pre>
//hippo:configuration/hippo:domains/${domainName}/element(*, hipposys:authrole)
[ @hipposys:users = '${username}' or @hipposys:groups = 'author' or @hipposys:groups = 'editor' ... ]
        </pre></div>
        </div>
        
<p>
          <i><b>Note: </b></i>
          the ${domainName} is replaced by the property, <a href="apidocs/org/onehippo/forge/security/support/springsecurity/authentication/HippoUserDetailsServiceImpl.html#setRoleDomainNamejava.lang.String">roleDomainName</a> ('everywhere' by default),
          and the ${username} is replaced by the real username at runtime,
          and the parts after 'or @hipposys:groups = ' are appended at runtime based on all the group names which were found in the previous step.
          So, for example, if the domainName is 'everywhere', the username is 'jdoe' and the user is in both 'author' and 'editor' groups,
          then the JCR query to execute should be like the following:
        </p>
        
<div class="brush: plain">
        
<div class="source"><pre>
//hippo:configuration/hippo:domains/everywhere/element(*, hipposys:authrole)
[ @hipposys:users = 'jdoe' or @hipposys:groups = 'author' or @hipposys:groups = 'editor' ]
        </pre></div>
        </div>
        
<p>
          Next, in each <code>hipposys:authrole</code> node under the specified domain node (/hippo:configuration/hippo:domains/everywhere/ by default),
          <code>HippoUserDetailsServiceImpl</code> reads <code>hipposys:role</code> property.
        </p>
        
<p>
          A role name will be the concatenation of the role prefix property ('ROLE_' by default) and the <code>hipposys:role</code> property value.
        </p>
        
<p>
          For example, suppose the JCR query above resulted in:
        </p>
        
<ul>
          
<li>
            /hippo:configuration/hippo:domains/everywhere/hippo:authrole
            <br />
            &#160;&#160;- hipposys:role = &quot;editor&quot;
          </li>
          
<li>
            /hippo:configuration/hippo:domains/everywhere/hippo:authrole
            <br />
            &#160;&#160;- hipposys:role = &quot;admin&quot;
          </li>
        </ul>
        
<p>
          Then, the end result of role names in <code>HippoUserDetailsServiceImpl</code> will be like the following set by default:
        </p>
        
<div class="brush: javascript">
        
<div class="source"><pre>
[ &quot;ROLE_editor&quot;, &quot;ROLE_admin&quot; ]
        </pre></div>
        </div>
      </section>

    </section>

  

    </div>
    </div>
    </div>
    <hr/>
    <footer>
    <div class="container-fluid">
      <div class="row-fluid">
          <p class="copyright">Copyright &copy;      2007&#x2013;2022
              <a href="https://www.bloomreach.com/">Bloomreach</a>.
          
</p>
    </div>
            </div>
  </footer>
    </body>
</html>

